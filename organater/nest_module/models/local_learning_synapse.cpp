#include "local_learning_synapse.h"
#include "connection.h"
#include <algorithm> // std::min, std::max ã®ãŸã‚ã«å¿…è¦
#include <cmath>     // std::abs ã®ãŸã‚ã«å¿…è¦

namespace nest_module {

// ----------------------------------------------------------------------
// è£œåŠ©é–¢æ•°: é›¢æ•£çš„ãªçŠ¶æ…‹ã‚’æµ®å‹•å°æ•°ç‚¹é‡ã¿ã«å¤‰æ›
// ----------------------------------------------------------------------
nest::double_t LocalLearningSynapse::state_to_weight(SynapticState state) const
{
    switch (state) {
        case SynapticState::NONE:
            return 0.0;
        case SynapticState::WEAK_EXC:
            return p_.weight_exc_weak;
        case SynapticState::STRONG_EXC:
            return p_.weight_exc_strong;
        case SynapticState::WEAK_INH:
            return p_.weight_inh_weak;
        case SynapticState::STRONG_INH:
            return p_.weight_inh_strong;
    }
    // æœªå®šç¾©ã®çŠ¶æ…‹ãŒæ¥ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆé€šå¸¸ã¯ç™ºç”Ÿã—ãªã„ï¼‰
    return 0.0; 
}


// ----------------------------------------------------------------------
// ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
// ----------------------------------------------------------------------
LocalLearningSynapse::LocalLearningSynapse()
: w_state_(SynapticState::WEAK_EXC) // ğŸ’¡ é›¢æ•£çš„ãªé‡ã¿çŠ¶æ…‹ã‚’åˆæœŸåŒ–ï¼ˆä¾‹ã¨ã—ã¦å¼±èˆˆå¥®æ€§ï¼‰
{
    // ğŸ’¡ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    p_.eta = 1.0; // é›¢æ•£çš„ãªå­¦ç¿’å‰‡ã§ã¯ã€etaã¯ãƒ–ãƒ¼ãƒ«æ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸã¨ãã®ã€Œé·ç§»ã®å¼·ã•ã€ã‚’ç¤ºã™å®šæ•°
    p_.min_w = -10.0; // é€£ç¶šçš„ãªã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ã¯è¡Œã‚ãªã„ãŒã€å¿µã®ãŸã‚ä¿æŒ
    p_.max_w = 10.0;
    
    // ğŸ’¡ é›¢æ•£çŠ¶æ…‹ã«å¯¾å¿œã™ã‚‹å®Ÿéš›ã®é‡ã¿å€¤ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    p_.weight_exc_weak = 0.5;
    p_.weight_exc_strong = 5.0;
    p_.weight_inh_weak = -0.5;
    p_.weight_inh_strong = -5.0;
}


// ----------------------------------------------------------------------
// ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®š
// ----------------------------------------------------------------------
void LocalLearningSynapse::set_properties(const Properties& p)
{
    p_ = p;
    // é‡ã¿è¨­å®šæ™‚ã€åˆæœŸçŠ¶æ…‹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èˆˆå¥®æ€§å¼±çµåˆã«ãƒªã‚»ãƒƒãƒˆ
    // ã¾ãŸã¯ã€è¨­å®šã•ã‚ŒãŸé‡ã¿å€¤ã«è¿‘ã„çŠ¶æ…‹ã«åˆæœŸåŒ–ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½åŠ å¯èƒ½
}


// ----------------------------------------------------------------------
// ã‚¹ãƒ‘ã‚¤ã‚¯ãƒ’ãƒƒãƒˆæ™‚ã®å‡¦ç†ï¼ˆå­¦ç¿’å‰‡ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
// ----------------------------------------------------------------------
void LocalLearningSynapse::hit_presynaptic(
    nest::double_t, 
    nest::double_t, 
    const nest::Spike&, 
    nest::Connection* connection)
{
    // ğŸ’¡ èˆˆå¥®æ€§ã®é‡ã¿å€¤ã‚’å–å¾—ã—ã€æ¥ç¶šå…ˆã«ä¼é”
    // èˆˆå¥®æ€§ã‹æŠ‘åˆ¶æ€§ã‹ã‚’åˆ¤å®šã—ã€çµ¶å¯¾å€¤ã¨ã—ã¦ã‚«ãƒ¼ãƒãƒ«ã«é‡ã¿ã‚’æ¸¡ã™ã€‚
    // w_state_ãŒenumã®ãŸã‚ã€state_to_weightã‚’ä½¿ã£ã¦doubleã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
    nest::double_t current_weight = state_to_weight(w_state_);
    connection->set_weight(current_weight);
    
    // ------------------------------------------------------------------
    // ğŸ’¡ NANDãƒ™ãƒ¼ã‚¹ã®åŸå­çš„ãªå­¦ç¿’å‰‡ã®éª¨æ ¼ (çŠ¶æ…‹é·ç§»)
    // ------------------------------------------------------------------
    
    // TODO: 1. å¾Œã‚·ãƒŠãƒ—ã‚¹ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ä¿¡å· E ã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
    // bool E_is_present = get_error_signal_from_post_neuron(); 
    bool E_is_present = false; // ç¾çŠ¶ã¯ä»®ã®ãƒ–ãƒ¼ãƒ«å€¤
    
    // TODO: 2. å‰å›å…¥åŠ›ã®æœ‰ç„¡ X ã‚’å‚ç…§ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
    bool X_is_present = true; // hit_presynapticãŒå‘¼ã°ã‚ŒãŸæ™‚ç‚¹ã§å‰ã‚¹ãƒ‘ã‚¤ã‚¯ã¯æ¥ãŸ(X=1)

    // ğŸ’¡ NANDå­¦ç¿’å‰‡ã®è«–ç†ã«åŸºã¥ã„ãŸåŸå­çš„ãªçŠ¶æ…‹é·ç§»ï¼ˆä¾‹ï¼‰
    if (X_is_present && E_is_present) {
        // æ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸå ´åˆã€é‡ã¿çŠ¶æ…‹ã‚’é›¢æ•£çš„ã«é·ç§»ã•ã›ã‚‹
        
        if (w_state_ == SynapticState::WEAK_EXC) {
            w_state_ = SynapticState::STRONG_EXC; // å¼±èˆˆå¥®æ€§ -> å¼·èˆˆå¥®æ€§ã¸ã‚¸ãƒ£ãƒ³ãƒ—
        } 
        // ä»–ã®è«–ç†çš„æ¡ä»¶ï¼ˆæŠ‘åˆ¶ã€ãƒªã‚»ãƒƒãƒˆãªã©ï¼‰ã‚’ã“ã“ã«è¿½åŠ 

    } else {
        // ã‚¨ãƒ©ãƒ¼ãŒãªã„ã€ã¾ãŸã¯å…¥åŠ›ãŒãªã„å ´åˆã®å‡¦ç†ï¼ˆå®‰å®šåŒ–ã€ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆï¼‰
        
        if (w_state_ == SynapticState::STRONG_EXC) {
            // w_state_ = SynapticState::WEAK_EXC; // ä¾‹: å¼·ã„çŠ¶æ…‹ã‚’å¼±ã‚ã‚‹
        }
    }
    
    // ğŸ’¡ çŠ¶æ…‹é·ç§»å¾Œã«æ–°ã—ã„é‡ã¿ã‚’è¨­å®šã—ç›´ã™ï¼ˆçŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿ï¼‰
    connection->set_weight(state_to_weight(w_state_));

}

} // namespace nest_module